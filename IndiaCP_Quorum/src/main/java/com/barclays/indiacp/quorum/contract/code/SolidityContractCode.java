package com.barclays.indiacp.quorum.contract.code;

import com.jpmorgan.cakeshop.client.model.Contract;
import com.jpmorgan.cakeshop.model.ContractABI;
import com.jpmorgan.cakeshop.model.SolidityType;

import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;

/**
 * Created by ritukedia on 28/12/16.
 */
public class SolidityContractCode {

    private String contractName;
    private String contractCode;
    private String contractBinary;
    private ContractABI contractABI;

    private static SolidityContractCode singleInstance;

    public static SolidityContractCode getSingleInstance(String contractName) {
        if (singleInstance == null) {
            singleInstance = new SolidityContractCode(contractName);
        }
        return singleInstance;
    }

    private SolidityContractCode(String contractName) {
        //Load contractName.sol
        try {
//            ClassLoader classLoader = getClass().getClassLoader();
//            File file = new File(classLoader.getResource("DL_CONFIG.properties").getFile());
//            FileInputStream input = new FileInputStream(file);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }

        //Compile contractName.sol

        //populate contract code
        contractCode = "contract CPProgram{\n" +
                "\n" +
                "  string public programId;\n" +
                "  string public name;\n" +
                "  string public _type;\n" +
                "  string public purpose;\n" +
                "  string public issueCommencementDate;\n" +
                "  string public programCurrency;\n" +
                "  uint public programSize;\n" +
                "  uint public programAllocatedValue;\n" +
                "  uint public maturityDays;\n" +
                "  \n" +
                "  //Document Hash Identifiers\n" +
                "  string public isinGenerationDocId;\n" +
                "  string public ipaVerificationDocId;\n" +
                "  string public ipaCertificateDocId;\n" +
                "  string public corporateActionFormDocId;\n" +
                "  string public allotmentLetterDocId;\n" +
                "  \n" +
                "  //Populate through network mapping service\n" +
                "  address public issuerAddress;\n" +
                "  //address public ipaAddress;\n" +
                "  //address public depositoryAddress;\n" +
                "  \n" +
                "  //status fields\n" +
                "  uint public version;\n" +
                "  string public status;\n" +
                "  //uint public lastModified;\n" +
                "  \n" +
                "  function CPProgram(string _programId, string _name, string __type, string _purpose, uint _programSize, uint _maturityDays){\n" +
                "    programId = _programId;\n" +
                "    name = _name;\n" +
                "    _type = __type;\n" +
                "    purpose = _purpose;\n" +
                "    programSize = _programSize;\n" +
                "    maturityDays = _maturityDays;\n" +
                "    \n" +
                "    //Default values\n" +
                "    programAllocatedValue = 0;\n" +
                "    issuerAddress = msg.sender;\n" +
                "    programCurrency = \"INR\";\n" +
                "    //ipaAddress = \"\";\n" +
                "    version = 1;\n" +
                "    status = \"Initiated\";\n" +
                "    //lastModified = now;\n" +
                "    \n" +
                "  }\n" +
                "  \n" +
                "  function fetchCPProgram() returns (string) {\n" +
                "    return name;\n" +
                "  }\n" +
                "}\n";

        //populate contract binary
        contractBinary = "60606040526040516115cb3803806115cb833981016040528080518201919060200180518201919060200180518201919060200180518201919060200180519060200190919080519060200190919050505b8560006000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100a057805160ff19168380011785556100d1565b828001600101855582156100d1579182015b828111156100d05782518260005055916020019190600101906100b2565b5b5090506100fc91906100de565b808211156100f857600081815060009055506001016100de565b5090565b50508460016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061014d57805160ff191683800117855561017e565b8280016001018555821561017e579182015b8281111561017d57825182600050559160200191906001019061015f565b5b5090506101a9919061018b565b808211156101a5576000818150600090555060010161018b565b5090565b50508360026000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106101fa57805160ff191683800117855561022b565b8280016001018555821561022b579182015b8281111561022a57825182600050559160200191906001019061020c565b5b5090506102569190610238565b808211156102525760008181506000905550600101610238565b5090565b50508260036000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106102a757805160ff19168380011785556102d8565b828001600101855582156102d8579182015b828111156102d75782518260005055916020019190600101906102b9565b5b50905061030391906102e5565b808211156102ff57600081815060009055506001016102e5565b5090565b50508160066000508190555080600860005081905550600060076000508190555033600e60006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690830217905550604060405190810160405280600381526020017f494e52000000000000000000000000000000000000000000000000000000000081526020015060056000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106103d757805160ff1916838001178555610408565b82800160010185558215610408579182015b828111156104075782518260005055916020019190600101906103e9565b5b5090506104339190610415565b8082111561042f5760008181506000905550600101610415565b5090565b50506001600f60005081905550604060405190810160405280600981526020017f496e69746961746564000000000000000000000000000000000000000000000081526020015060106000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106104c857805160ff19168380011785556104f9565b828001600101855582156104f9579182015b828111156104f85782518260005055916020019190600101906104da565b5b5090506105249190610506565b808211156105205760008181506000905550600101610506565b5090565b50505b5050505050506110908061053b6000396000f3606060405236156100f8576000357c01000000000000000000000000000000000000000000000000000000009004806306fdde03146100fa578063200d2ed21461017557806323b9e2d3146101f0578063257186061461026b57806339d3ab9b146102e6578063502eb22d1461036157806354fd4d50146103dc57806370740aab146103ff57806393bf48631461047a5780639809e119146104f557806398812da814610570578063a63234e0146105eb578063baf1187314610624578063bbd9831a1461069f578063d4c51e35146106c2578063d5fbbf801461073d578063d85b270414610760578063e402cf63146107db576100f8565b005b61010760048050506107fe565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156101675780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b610182600480505061089f565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156101e25780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101fd6004805050610940565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561025d5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61027860048050506109fc565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156102d85780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6102f36004805050610a9d565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103535780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61036e6004805050610b3e565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103ce5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6103e96004805050610bdf565b6040518082815260200191505060405180910390f35b61040c6004805050610be8565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561046c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6104876004805050610c89565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156104e75780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6105026004805050610d2a565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156105625780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61057d6004805050610dcb565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156105dd5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6105f86004805050610e6c565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6106316004805050610e92565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156106915780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6106ac6004805050610f33565b6040518082815260200191505060405180910390f35b6106cf6004805050610f3c565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561072f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61074a6004805050610fdd565b6040518082815260200191505060405180910390f35b61076d6004805050610fe6565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156107cd5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6107e86004805050611087565b6040518082815260200191505060405180910390f35b60016000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108975780601f1061086c57610100808354040283529160200191610897565b820191906000526020600020905b81548152906001019060200180831161087a57829003601f168201915b505050505081565b60106000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109385780601f1061090d57610100808354040283529160200191610938565b820191906000526020600020905b81548152906001019060200180831161091b57829003601f168201915b505050505081565b602060405190810160405280600081526020015060016000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109ed5780601f106109c2576101008083540402835291602001916109ed565b820191906000526020600020905b8154815290600101906020018083116109d057829003601f168201915b505050505090506109f9565b90565b60056000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a955780601f10610a6a57610100808354040283529160200191610a95565b820191906000526020600020905b815481529060010190602001808311610a7857829003601f168201915b505050505081565b600c6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b365780601f10610b0b57610100808354040283529160200191610b36565b820191906000526020600020905b815481529060010190602001808311610b1957829003601f168201915b505050505081565b60046000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bd75780601f10610bac57610100808354040283529160200191610bd7565b820191906000526020600020905b815481529060010190602001808311610bba57829003601f168201915b505050505081565b600f6000505481565b60036000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c815780601f10610c5657610100808354040283529160200191610c81565b820191906000526020600020905b815481529060010190602001808311610c6457829003601f168201915b505050505081565b60096000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d225780601f10610cf757610100808354040283529160200191610d22565b820191906000526020600020905b815481529060010190602001808311610d0557829003601f168201915b505050505081565b600d6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610dc35780601f10610d9857610100808354040283529160200191610dc3565b820191906000526020600020905b815481529060010190602001808311610da657829003601f168201915b505050505081565b60006000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610e645780601f10610e3957610100808354040283529160200191610e64565b820191906000526020600020905b815481529060010190602001808311610e4757829003601f168201915b505050505081565b600e60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600a6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f2b5780601f10610f0057610100808354040283529160200191610f2b565b820191906000526020600020905b815481529060010190602001808311610f0e57829003601f168201915b505050505081565b60076000505481565b600b6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610fd55780601f10610faa57610100808354040283529160200191610fd5565b820191906000526020600020905b815481529060010190602001808311610fb857829003601f168201915b505050505081565b60086000505481565b60026000508054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561107f5780601f106110545761010080835404028352916020019161107f565b820191906000526020600020905b81548152906001019060200180831161106257829003601f168201915b505050505081565b6006600050548156";

        //populate contract abi
        String abiJSON = "[{\"constant\":true,\"inputs\":[],\"name\":\"name\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"status\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"fetchCPProgram\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"programCurrency\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"corporateActionFormDocId\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"issueCommencementDate\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"version\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"purpose\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"isinGenerationDocId\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"allotmentLetterDocId\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"programId\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"issuerAddress\",\"outputs\":[{\"name\":\"\",\"type\":\"address\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"ipaVerificationDocId\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"programAllocatedValue\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"ipaCertificateDocId\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"maturityDays\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"_type\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"programSize\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"type\":\"function\"},{\"inputs\":[{\"name\":\"_programId\",\"type\":\"string\"},{\"name\":\"_name\",\"type\":\"string\"},{\"name\":\"__type\",\"type\":\"string\"},{\"name\":\"_purpose\",\"type\":\"string\"},{\"name\":\"_programSize\",\"type\":\"uint256\"},{\"name\":\"_maturityDays\",\"type\":\"uint256\"}],\"type\":\"constructor\"}]\n";
        contractABI = ContractABI.fromJson(abiJSON);

    }

    public String getContractCode() {
        return contractCode;
    }

    public String getContractBinary() {
        return contractBinary;
    }

    public ContractABI getContractABI() {
        return contractABI;
    }

    public Contract.CodeTypeEnum getCodeType() {
        return Contract.CodeTypeEnum.SOLIDITY;
    }

    public Object[] getConstructorArgs(Object contractModel) {
        try {
            List<Object> constructorArgs = new ArrayList<Object>();
            //TODO use the ABI and reflection to extract constructor arguments
            ContractABI.Constructor constructor = contractABI.getConstructor();
            List<ContractABI.Entry.Param> constructorParams = constructor.inputs;
            for (ContractABI.Entry.Param param : constructorParams) {
                String argName = param.getName();
                SolidityType argType = param.getType();
                String getterMethodName = getGetterMethodName(argName);

                Method method = contractModel.getClass().getMethod(getterMethodName);
                Object paramValue = method.invoke(contractModel);

                constructorArgs.add(getParamValue(paramValue, argType));
            }
            return constructorArgs.toArray();
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    private Object getParamValue(Object paramValue, SolidityType argType) {
        if (paramValue == null) {
            if (argType.getClass().equals(SolidityType.StringType.class)) {
                paramValue = "";
            } else {
                paramValue = 0;
            }
        }
        return paramValue;
    }

    private String getGetterMethodName(String argName) {
        // Param name type is a special variable in Solidity hence the IndiaCP Contract classes have used _type instead.
        // Handling type param differently
        String getterMethodName = null;
        if (argName.equals("__type")) {
            getterMethodName = "getType";
        } else {
            getterMethodName = "get" + argName.substring(1,2).toUpperCase() + argName.substring(2,argName.length());
        }
        return getterMethodName;
    }

    private static Class<?> getJavaType(SolidityType solType) {
        switch (solType.getName()) {
            case "string":
                return String.class;
            case "uint256":
                return Integer.class;
            default: return Object.class;
        }
    }
}
